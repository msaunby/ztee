<html>
<head>
  <title>tones</title>
</head>
<body>

  <button onclick="TogetherJS(this); return false;">Start TogetherJS</button>

  <button id="one" class="key" onmousedown="dialTone(697.0, 1209.0)"  onmouseup="stop()" data-freq='697.0, 1209.0'>1</button>

  <button id="test">test</button>

  <br>
  <input id="x" type="text" value="nil"></input>
  <br>
  <input id="y" type="text" value="nil"></input>
  <br>
  <input id="z" type="text" value="nil"></input>

  <video width="256" height="256"></video>
  <image id="jpg" width="256" height="256"></image>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- togetherjs -->
      <script>
        TogetherJSConfig_findRoom = {prefix: "ztee", max: 3};
        TogetherJSConfig_autoStart = true;
        TogetherJSConfig_suppressJoinConfirmation = true;
        TogetherJSConfig_storagePrefix = "tjs_ztee";
      </script>
  <script src="https://togetherjs.com/togetherjs-min.js"></script>
  <script src="adapter.js"></script>
  <script>

  var pulse = true;
  var beat_orientation = false;
  var recordfn = function(){};

  function videoTimer(){
    setTimeout( function() {
      videoTimer();
      recordfn();
    }, 1000 / 2 ); // 2fps
  }

  videoTimer();

  function heartbeat(){
    setTimeout( function() {
      heartbeat();
      pulse = !pulse;
      beat_orientation = true;
      if(pulse){
        $('#test').css('background-color', 'red');
      }else{
        $('#test').css('background-color', 'white');
      }
    }, 500 );
  }

  heartbeat();

  var AudioContext = window.AudioContext || window.webkitAudioContext;
  var context = new AudioContext();

  var oscillator1, oscillator2;

  var dialTone = function(freq1, freq2){

    oscillator1 = context.createOscillator();
    oscillator1.type = 'sine';
    oscillator1.frequency.value = freq1;
    gainNode = context.createGain ? context.createGain() : context.createGainNode();
    oscillator1.connect(gainNode,0,0);
    gainNode.connect(context.destination);
    gainNode.gain.value = .1;
    oscillator1.start ? oscillator1.start(0) : oscillator1.noteOn(0)

    oscillator2 = context.createOscillator();
    oscillator2.type = 'sine';
    oscillator2.frequency.value = freq2;
    gainNode = context.createGain ? context.createGain() : context.createGainNode();
    oscillator2.connect(gainNode);
    gainNode.connect(context.destination);

    gainNode.gain.value = .1;
    oscillator2.start ? oscillator2.start(0) : oscillator2.noteOn(0)

  };

  function start() {
    if (typeof oscillator1 != 'undefined') oscillator1.disconnect();
    if (typeof oscillator2 != 'undefined') oscillator2.disconnect();
    oscOn(parseFloat(document.getElementById("freq").value),parseFloat(document.getElementById("freq2").value));
  }


  function stop() {
    oscillator1.disconnect();
    oscillator2.disconnect();
  }


  TogetherJS.hub.on("cursor-click", function (msg) {
    if (! msg.sameUrl) {
      console.log("MSG cursor-click SAME URL");
      return;
    }
    console.log("MSG cursor-click");
  });

  function handleOrientation(event) {
    if(beat_orientation){
      beat_orientation = false;
      if (TogetherJS.running) {
        TogetherJS.send({
          type: 'orientation',
          alpha: event.alpha,
          beta: event.beta,
          gamma: event.gamma
        });
      }
      var x = event.beta;  // In degree in the range [-180,180]
      var y = event.gamma; // In degree in the range [-90,90]
      var z = event.alpha; // In degree in the range [0,360]
      $('#x').val(x);
      $('#y').val(y);
      $('#z').val(z);
    }
  }

  window.addEventListener('deviceorientation', handleOrientation);

  $('#test').on("click", function(){
    console.log('Test clicked');
    if (TogetherJS.running) {
      TogetherJS.send({
        type: 'test-orientation',
        alpha: 12.4,
        beta: -11.2,
        gamma: 0.04
      });
    }
  });



TogetherJS.hub.on('orientation', function (msg) {
  if (!msg.sameUrl) {
    return;
  }
  var x = msg.beta;  // In degree in the range [-180,180]
  var y = msg.gamma; // In degree in the range [-90,90]
  var z = msg.alpha; // In degree in the range [0,360]
  $('#x').val(x);
  $('#y').val(y);
  $('#z').val(z);
  console.log(msg);
});

var constraint = { audio: false, video: { width: { facingMode: "user" } } };
var recordCanvas;

var p = navigator.mediaDevices.getUserMedia( constraint );

p.then(function(mediaStream) {
   var video = document.querySelector('video');
   video.src = window.URL.createObjectURL(mediaStream);
   video.play();
   video.onloadedmetadata = function(e) {
      // Do something with the video here.
      console.log('have video metadata', video);
      recordCanvas = document.createElement('canvas');
      recordCanvas.width = video.width;
      recordCanvas.height = video.height;
      recordfn = function(){
        recordCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
        var jpg = recordCanvas.toDataURL('image/jpeg', 50);
        //$('#jpg')[0].src = jpg;
        if (TogetherJS.running) {
          TogetherJS.send({
            type: 'video',
            image: jpg,
            alpha: 0.0,
            beta: 0.0,
            gamma: 0.0
          });
        }
      }
   };
   video.onloadeddata = function(e) {
      // Do something with the video here.
      console.log('have videoWidth', video.videoWidth);
      //recordCanvas = document.createElement('canvas');
      //recordCanvas.width = video.width;  // or videoWidth
      //recordCanvas.height = video.height; // or videoHeight
   };
});

p.catch(function(e) { console.log(e.name); }); // always check for errors at the end.

TogetherJS.hub.on('video', function (msg) {
  if (!msg.sameUrl) {
    return;
  }
  $('#jpg')[0].src = msg.image;
});

  </script>

</body>
</html>
